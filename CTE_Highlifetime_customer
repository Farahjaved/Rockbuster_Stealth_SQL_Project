### Where  are  customers  with  a  high  lifetime  value  based? 
### This query gives us the top 5 high paying customers from the top 10 cities in terms of customer count.

with city_name_cte AS (
  SELECT
    C.city
  FROM customer A
  INNER JOIN address B ON A.address_id = B.address_id
  INNER JOIN city C ON B.city_id = C.city_id
  INNER JOIN country D ON C.country_ID = D.country_ID
  INNER JOIN top_ten_countries E ON E.country = D.country
  GROUP BY C.city, D.country
  ORDER BY COUNT(A.customer_id) DESC
  LIMIT 10),
amount_cte(Total_Amount,customer_id,first_name,last_name,city,country) AS
  (SELECT
    sum(A.amount) AS Total_Amount,
    B.customer_id,
    B.first_name,
    B.last_name,
    D.city,
    E.country
  FROM payment A
  INNER JOIN customer B ON A.customer_id = B.customer_id
  INNER JOIN address C ON B.address_id = C.address_id
  INNER JOIN city D ON C.city_id = D.city_id
  INNER JOIN country E ON D.country_ID = E.country_ID
  INNER JOIN top_ten_countries F ON E.country = F.country
  WHERE D.city IN (
      SELECT city FROM city_name_cte)
  GROUP BY
    B.customer_id,
    B.first_name,
    B.last_name,
    D.city,
    E.country
  ORDER BY Total_Amount DESC
  LIMIT 5 ),
all_customer_cte AS(
  SELECT
    D.country,
    Total_Amount,
    COUNT(DISTINCT A.customer_id) AS all_customer_count,
    COUNT(DISTINCT amount_cte.customer_id) AS top_customer_count
  FROM customer A
  INNER JOIN address B ON A.address_id = B.address_id
  INNER JOIN city C ON B.city_id = C.city_id
  INNER JOIN country D ON C.country_ID = D.country_ID
  LEFT JOIN amount_cte ON D.country = amount_cte.country
  GROUP BY D.country, amount_cte.Total_Amount
  ORDER BY top_customer_count, amount_cte.Total_Amount DESC)
SELECT
  country,
  all_customer_count,
  top_customer_count,
  Total_Amount
FROM all_customer_cte
ORDER BY top_customer_count DESC;
